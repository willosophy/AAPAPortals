parameters:
  artifactName: ""
  SolutionName: ""

jobs:
  - job: Unpack_Solutions
    pool:
      VmImage: "vs2017-win2016"

    steps:
      - download: current

      - task: PowerAppsToolInstaller@0

      - pwsh: |
          New-Item -Path "$(Pipeline.Workspace)" -Name "solutions" -ItemType "directory"
          Copy-Item -Path "$(Pipeline.Workspace)\${{ parameters.artifactName }}-${{ parameters.SolutionName }}\*" -Destination "$(Pipeline.Workspace)\solutions" -Recurse
          Copy-Item -Path "$(Pipeline.Workspace)\${{ parameters.artifactName }}-${{ parameters.SolutionName }}_managed\*" -Destination "$(Pipeline.Workspace)\solutions" -Recurse
       displayName: Copy solutions to 

      # Unpack both managed and unmanaged solution
      - task: PowerAppsUnpackSolution@0
        inputs:
          SolutionInputFile: '$(Pipeline.Workspace)\solutions\${{ parameters.SolutionName }}.zip'
          SolutionTargetFolder: '$(Build.SourcesDirectory)\solutions\${{ parameters.SolutionName }}'
          SolutionType: Both

      - publish: $(Pipeline.Workspace)/${{ parameters.artifactName }}
        artifact: ${{ parameters.artifactName }}

      - checkout: self
        persistCredentials: true

      # Reattach to branch (variable)
      # Configure user.name and user.email
      - pwsh: |
          git checkout ("$(Build.SourceBranch)" -replace "^refs/heads/", "")
          git config user.name "Automated Pipeline Commit"
          git config user.email "PPALM-Exploration-Build-Account"
        displayName: "Checkout branch and config user"

      - download: current

      - script: |
          git add .
          git commit -m "Automated commit of solutions: ${{ parameters.SolutionName }}"
          git push
        displayName: "Automated commit of solutions: ${{ parameters.SolutionName }}"
      # TODO ensure project collection build service accounts has contribute permissions
